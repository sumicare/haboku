resource "kubernetes_manifest" "certificate_test-app_ca" {
  for_each = var.deploy_custom_resources ? toset(["test-app"]) : toset([])

  manifest = {
    apiVersion = "cert-manager.io/v1"
    kind       = "Certificate"
    metadata = {
      labels    = local.labels
      name      = "${local.app_name}-ca"
      namespace = local.namespace
    }
    spec = {
      commonName = local.app_name
      duration   = "43800h0m0s"
      isCA       = true
      issuerRef = {
        group = "cert-manager.io"
        kind  = "Issuer"
        name  = var.ca_issuer != null ? var.ca_issuer : "${local.app_name}-ca-issuer"
      }
      privateKey = {
        algorithm = "RSA"
        size      = 2048
      }
      renewBefore    = "14600h0m0s"
      secretName     = "${local.app_name}-ca"
      secretTemplate = {}
    }
  }
}